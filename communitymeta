#!/usr/bin/env python3

import shlex
import os
import sys
import subprocess

metadir = os.path.expanduser("~/.communitymeta/")

def parseMetadata():
    # This could be stored in an sqlite database for speed
    packages = []
    for package in os.listdir(metadir):
        if not os.path.isfile(metadir + package):
            continue
        with open(metadir + package) as file:
            pacmeta = {}
            for line in file:
                columns = shlex.split(line)
                if not columns:
                    continue
                pacmeta[columns[0]] = columns[1:]
            packages.append((package, pacmeta))
    return packages

def sync():
    if not os.path.exists(metadir):
        subprocess.call(["git", "clone",
            "git://github.com/ids1024/archcommunitymetadata", metadir])
    else:
        os.chdir(metadir)
        subprocess.call(["git", "pull"])


if __name__ == "__main__":
    if len(sys.argv) > 1 and sys.argv[1] == "--sync":
        sync()
        sys.exit(0)
    packages = parseMetadata()
    params = []
    for arg in sys.argv[1:]:
        param = arg.split('=')
        if len(param) != 2:
            print("Error: Improperly formatted argument")
            sys.exit(1)
        params.append(param)
    for package, pacmeta in packages:
        for name, value in params:
            if value not in pacmeta.get(name, ()):
                break
        else:
            print(package)
